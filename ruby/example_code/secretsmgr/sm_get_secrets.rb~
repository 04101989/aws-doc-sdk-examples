#!/usr/bin/env ruby

require 'aws-sdk-secretsmanager'
require 'os'

USAGE = <<DOC

Usage: sm_get_secrets.rb [-r REGION] [-d] [-h] [-s SECRET]

  Lists your secrets.

  If SECRET is supplied, gets that value of that secret

  If REGION is not supplied, defaults to us-west-2

  -h displays this message and quits

DOC

if OS.windows?
  Aws.use_bundled_cert!
end

# main
region = 'us-west-2'
secret = ''

i = 0

while i < ARGV.length
  case ARGV[i]
    when '-r'
      i += 1
      region = ARGV[i]

    when '-s'
      i += 1
      secret = ARGV[i]

    when '-h'
      puts USAGE
      exit 0

    else
      puts 'Error! Bad arg: ' + ARGV[i]
      puts USAGE
      exit(1)
  end

  i += 1
end

sm = Aws::SecretsManager::Client.new(region: region)

if secret == ''
  resp = sm.list_secrets

  puts 'Secrets:'

  resp.secret_list.each do |s|
    puts '  ' + s.name
  end
else
  resp = sm.get_secret_value(secret_id: secret)

  if resp.secret_string
    puts resp.secret_string
  else
    # do something with resp.secret_binary
  end
end
